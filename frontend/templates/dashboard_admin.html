{% extends "base.html" %}
{% block title %}Admin Dashboard ‚Äî IT Ticket Engine{% endblock %}

{% block content %}
<div class="main-content">

    <div class="page-header">
        <h1>üõ°Ô∏è Admin Dashboard</h1>
        <p>Hello, {{ session.user_name }}! Manage tickets, add resolutions and view analytics.</p>
    </div>

    <!-- TABS -->
    <div class="tabs" id="admin-tabs">
        <button class="tab-btn active" data-tab="all-tab">üìã All Tickets <span class="score-pill">{{ tickets|length
                }}</span></button>
        <button class="tab-btn" data-tab="esc-tab">üö® Escalated <span class="score-pill">{{ escalated|length
                }}</span></button>
        <button class="tab-btn" data-tab="res-tab">‚ûï Add Resolution</button>
        <button class="tab-btn" data-tab="analytics-tab">üìä Analytics</button>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <!-- TAB: ALL TICKETS                                        -->
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="all-tab" class="tab-pane active">
        <h3 class="section-title">üìã All Support Tickets</h3>

        {% if tickets %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Escalated</th>
                        <th>AI Score</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    <tr>
                        <td><strong>#{{ t.id }}</strong></td>
                        <td class="desc-cell" title="{{ t.description }}">{{ t.description }}</td>
                        <td>{{ t.category or '‚Äî' }}</td>
                        <td>
                            {% if t.priority == 'High' %}
                            <span class="badge badge-escalated">{{ t.priority }}</span>
                            {% elif t.priority == 'Low' %}
                            <span class="badge badge-resolved">{{ t.priority }}</span>
                            {% else %}
                            <span class="badge badge-inprogress">{{ t.priority }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set s = t.status %}
                            {% if s == 'Open' %} <span class="badge badge-open">{{ s }}</span>
                            {% elif s == 'Resolved' %} <span class="badge badge-resolved">{{ s }}</span>
                            {% elif s == 'Pending' %} <span class="badge badge-pending">{{ s }}</span>
                            {% elif s == 'Closed' %} <span class="badge badge-closed">{{ s }}</span>
                            {% else %} <span class="badge badge-inprogress">{{ s }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if t.escalation_flag %}
                            <span class="badge badge-escalated">üî¥ Yes</span>
                            {% else %}
                            <span class="badge badge-resolved">üü¢ No</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if t.similarity_score %}
                            <span class="score-pill">{{ (t.similarity_score * 100) | round(1) }}%</span>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-muted" style="font-size:0.78rem;">
                            {{ t.created_at[:16] if t.created_at else '‚Äî' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted mt-1" style="font-size:0.8rem;">Total: {{ tickets|length }} ticket(s)</p>
        {% else %}
        <div class="empty-state">
            <span class="empty-icon">üé´</span>
            <p>No tickets found yet.</p>
        </div>
        {% endif %}

        <!-- Update Status -->
        <hr class="section-divider" />
        <h4 class="section-title">‚úèÔ∏è Update Ticket Status</h4>
        <div style="max-width:480px;">
            <form method="POST" action="{{ url_for('admin_update_status') }}">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ticket ID</label>
                        <input class="form-control" type="number" name="ticket_id" min="1" placeholder="e.g. 3"
                            required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Status</label>
                        <select class="form-control" name="status">
                            <option>Open</option>
                            <option>In Progress</option>
                            <option>Resolved</option>
                            <option>Closed</option>
                            <option>Pending</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </form>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <!-- TAB: ESCALATED                                          -->
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="esc-tab" class="tab-pane">
        <h3 class="section-title">üö® Escalated Tickets</h3>

        {% if escalated %}
        <div class="alert alert-warning mb-2">
            ‚ö†Ô∏è {{ escalated|length }} ticket(s) require manual attention.
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in escalated %}
                    <tr>
                        <td><strong>#{{ t.id }}</strong></td>
                        <td class="desc-cell" title="{{ t.description }}">{{ t.description }}</td>
                        <td>{{ t.category or '‚Äî' }}</td>
                        <td>
                            {% if t.priority == 'High' %}<span class="badge badge-escalated">{{ t.priority }}</span>
                            {% elif t.priority == 'Low' %}<span class="badge badge-resolved">{{ t.priority }}</span>
                            {% else %}<span class="badge badge-inprogress">{{ t.priority }}</span>{% endif %}
                        </td>
                        <td>
                            {% set s = t.status %}
                            {% if s == 'Pending' %}<span class="badge badge-pending">{{ s }}</span>
                            {% elif s == 'Resolved' %}<span class="badge badge-resolved">{{ s }}</span>
                            {% else %}<span class="badge badge-open">{{ s }}</span>{% endif %}
                        </td>
                        <td class="text-muted" style="font-size:0.78rem;">
                            {{ t.created_at[:16] if t.created_at else '‚Äî' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Quick resolve -->
        <hr class="section-divider" />
        <h4 class="section-title">‚úèÔ∏è Update Escalated Ticket</h4>
        <div style="max-width:480px;">
            <form method="POST" action="{{ url_for('admin_update_status') }}">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ticket ID</label>
                        <input class="form-control" type="number" name="ticket_id" min="1" placeholder="e.g. 3"
                            required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Status</label>
                        <select class="form-control" name="status">
                            <option>In Progress</option>
                            <option>Resolved</option>
                            <option>Closed</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update</button>
            </form>
        </div>

        {% else %}
        <div class="empty-state">
            <span class="empty-icon">üéâ</span>
            <p>No escalated tickets at the moment!</p>
        </div>
        {% endif %}
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <!-- TAB: ADD RESOLUTION                                     -->
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="res-tab" class="tab-pane">
        <div style="max-width:680px;">
            <h3 class="section-title">‚ûï Add Manual Resolution</h3>
            <p class="text-indent mb-2">Add a resolution to a ticket. This will also mark the ticket as
                <strong>Resolved</strong>.
            </p>

            <!-- Ticket ID lookup to show existing NLP resolutions -->
            <div class="card mb-2">
                <h4 style="margin-bottom:0.8rem;">üîç Preview Existing NLP Suggestions</h4>
                <div style="display:flex;gap:0.8rem;align-items:flex-end;">
                    <div class="form-group" style="margin:0;flex:1;">
                        <label class="form-label" for="preview_ticket_id">Enter Ticket ID to preview</label>
                        <input class="form-control" type="number" id="preview_ticket_id" min="1" placeholder="e.g. 3" />
                    </div>
                    <button class="btn btn-secondary" type="button" onclick="loadNlpResolutions()"
                        style="margin-bottom:1.2rem;">
                        üîç Load Suggestions
                    </button>
                </div>
                <div id="nlp-preview" style="display:none;">
                    <p class="text-muted"
                        style="font-size:0.78rem;font-weight:700;text-transform:uppercase;margin-bottom:0.6rem;">ü§ñ
                        NLP-Generated Resolutions Already Saved for this Ticket:</p>
                    <div id="nlp-resolution-list"></div>
                </div>
                <div id="nlp-empty" style="display:none;">
                    <p class="text-muted">No NLP resolutions found for this ticket.</p>
                </div>
                <div id="nlp-error" style="display:none;" class="alert alert-danger"></div>
            </div>

            <div class="card">
                <form method="POST" action="{{ url_for('admin_add_resolution') }}">
                    <div class="form-group">
                        <label class="form-label" for="res_ticket_id">Ticket ID *</label>
                        <input class="form-control" type="number" id="res_ticket_id" name="ticket_id" min="1"
                            placeholder="Enter the ticket ID" required oninput="syncPreviewId(this.value)" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="resolution_text">Resolution Text *</label>
                        <textarea class="form-control" id="resolution_text" name="resolution_text" rows="6"
                            placeholder="Describe the steps taken to resolve this issue‚Ä¶" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        ‚úÖ Submit Resolution
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <!-- TAB: ANALYTICS                                          -->
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="analytics-tab" class="tab-pane">
        <h3 class="section-title">üìä System Analytics</h3>

        <!-- Metrics Row -->
        <div class="metrics-grid">
            <div class="metric-card indigo">
                <div class="metric-value">{{ analytics.total_tickets or 0 }}</div>
                <div class="metric-label">üì¨ Total Tickets</div>
            </div>
            <div class="metric-card green">
                <div class="metric-value">{{ analytics.resolved_tickets or 0 }}</div>
                <div class="metric-label">‚úÖ Resolved</div>
            </div>
            <div class="metric-card amber">
                <div class="metric-value">{{ (analytics.open_tickets or 0) + (analytics.pending_tickets or 0) }}</div>
                <div class="metric-label">üîì Open / Pending</div>
            </div>
            <div class="metric-card red">
                <div class="metric-value">{{ analytics.escalated_count or 0 }}</div>
                <div class="metric-label">üö® Escalated</div>
            </div>
        </div>

        <div class="two-col">
            <!-- Left: text stats -->
            <div>
                <div class="card mb-2">
                    <p class="text-muted"
                        style="font-size:0.78rem;text-transform:uppercase;font-weight:700;letter-spacing:0.5px;margin-bottom:0.5rem;">
                        üìÅ Most Common Category</p>
                    <div style="font-size:1.8rem;font-weight:800;color:var(--indigo-400);">
                        {{ analytics.most_common_category or '‚Äî' }}
                    </div>
                </div>
                <div class="card">
                    <p class="text-muted"
                        style="font-size:0.78rem;text-transform:uppercase;font-weight:700;letter-spacing:0.5px;margin-bottom:0.5rem;">
                        ‚è±Ô∏è Avg Resolution Time</p>
                    {% if analytics.avg_resolution_time_hours %}
                    <div style="font-size:1.8rem;font-weight:800;color:var(--green);">
                        {{ analytics.avg_resolution_time_hours | round(2) }} hrs
                    </div>
                    {% else %}
                    <p class="text-muted">No resolved ticket data yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Right: Chart -->
            <div class="chart-container">
                <p style="font-weight:700;margin-bottom:1rem;">üìä
                    {% if analytics.category_counts %}Tickets by Category{% else %}Open vs Resolved{% endif %}
                </p>
                <canvas id="analyticsChart" height="200"></canvas>
            </div>
        </div>
    </div><!-- /analytics-tab -->

</div><!-- /main-content -->
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // ‚îÄ‚îÄ Build Chart.js chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const adminAnalytics = {{ analytics | tojson }};
    const catCounts = adminAnalytics.category_counts;
    const ctx = document.getElementById('analyticsChart').getContext('2d');

    let labels, data;
    if (catCounts && Object.keys(catCounts).length) {
        const sorted = Object.entries(catCounts).sort((a, b) => b[1] - a[1]);
        labels = sorted.map(e => e[0]);
        data = sorted.map(e => e[1]);
    } else {
        labels = ['Open', 'Pending', 'Resolved'];
        data = [adminAnalytics.open_tickets || 0, adminAnalytics.pending_tickets || 0, adminAnalytics.resolved_tickets || 0];
    }

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Tickets',
                data,
                backgroundColor: [
                    'rgba(99,102,241,0.7)', 'rgba(139,92,246,0.7)', 'rgba(59,130,246,0.7)',
                    'rgba(34,197,94,0.7)', 'rgba(245,158,11,0.7)', 'rgba(239,68,68,0.7)',
                    'rgba(20,184,166,0.7)', 'rgba(236,72,153,0.7)', 'rgba(251,146,60,0.7)',
                ],
                borderColor: 'rgba(99,102,241,0.5)',
                borderWidth: 1,
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { color: 'rgba(99,102,241,0.08)' } },
                y: { ticks: { color: '#94a3b8', stepSize: 1 }, grid: { color: 'rgba(99,102,241,0.08)' }, beginAtZero: true }
            }
        }
    });

    // ‚îÄ‚îÄ Deep-link hash to tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('DOMContentLoaded', () => {
        const hash = window.location.hash.replace('#', '');
        const tabMap = {
            'all-tickets': 'all-tab',
            'escalated': 'esc-tab',
            'add-resolution': 'res-tab',
            'analytics': 'analytics-tab',
        };
        if (tabMap[hash]) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            const paneId = tabMap[hash];
            document.getElementById(paneId).classList.add('active');
            document.querySelector(`[data-tab="${paneId}"]`)?.classList.add('active');
        }
    });

    // ‚îÄ‚îÄ NLP Resolution Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadNlpResolutions() {
        const tid = document.getElementById('preview_ticket_id').value;
        const preview = document.getElementById('nlp-preview');
        const empty = document.getElementById('nlp-empty');
        const errBox = document.getElementById('nlp-error');
        const list = document.getElementById('nlp-resolution-list');

        if (!tid) { alert('Please enter a Ticket ID first.'); return; }

        preview.style.display = empty.style.display = errBox.style.display = 'none';
        list.innerHTML = '<p class="text-muted">‚è≥ Loading‚Ä¶</p>';
        preview.style.display = 'block';

        fetch(`/api/ticket/${tid}/resolutions`)
            .then(r => r.json())
            .then(data => {
                list.innerHTML = '';
                if (data.error) {
                    preview.style.display = 'none';
                    errBox.textContent = '‚ùå ' + data.error;
                    errBox.style.display = 'block';
                    return;
                }
                const resolutions = data.resolutions || [];
                if (!resolutions.length) {
                    preview.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }
                resolutions.forEach((r, i) => {
                    const text = typeof r === 'string' ? r : (r.resolution_text || '‚Äî');
                    const date = typeof r === 'object' && r.resolved_date ? r.resolved_date.slice(0, 16) : '';
                    list.innerHTML += `
                  <div class="resolution-block" style="margin-bottom:0.7rem;">
                    <div class="block-label">üí° Suggestion ${i + 1}${date ? ' ‚Äî ' + date : ''}</div>
                    <p style="margin:0.3rem 0 0;">${text}</p>
                  </div>`;
                });
                // Also sync ticket ID to the form below
                syncPreviewId(tid);
            })
            .catch(() => {
                preview.style.display = 'none';
                errBox.textContent = '‚ùå Network error. Is the backend running?';
                errBox.style.display = 'block';
            });
    }

    function syncPreviewId(val) {
        document.getElementById('preview_ticket_id').value = val;
    }
</script>
{% endblock %}